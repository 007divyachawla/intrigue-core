require 'rspec/core'
require 'rspec/core/rake_task'
require 'json'
require 'yaml'
require 'fileutils'

# Config files
intrigue_basedir = File.dirname(__FILE__)

# Configuration and scripts
puma_config_file = "#{intrigue_basedir}/config/puma.rb"
system_config_file = "#{intrigue_basedir}/config/config.json"
database_config_file = "#{intrigue_basedir}/config/database.yml"
sidekiq_interactive_config_file = "#{intrigue_basedir}/config/sidekiq-task-interactive.yml"
sidekiq_autoscheduled_config_file = "#{intrigue_basedir}/config/sidekiq-task-autoscheduled.yml"
sidekiq_enrichment_config_file = "#{intrigue_basedir}/config/sidekiq-task-enrichment.yml"
sidekiq_app_config_file = "#{intrigue_basedir}/config/sidekiq-app.yml"
control_script = "#{intrigue_basedir}/util/control.sh"

# Data files
geolocation_database = "#{intrigue_basedir}/data/geolitecity/latest.dat"
web_accounts_list =  "#{intrigue_basedir}/data/web_accounts_list/web_accounts_list.json"

desc "Clean"
task :clean do
  puts "[+] Cleaning up!"
  FileUtils.mv  puma_config_file, "#{puma_config_file}.backup"
  FileUtils.mv  system_config_file, "#{system_config_file}.backup"
  FileUtils.mv  database_config_file, "#{database_config_file}.backup"
  FileUtils.mv  sidekiq_interactive_config_file, "#{sidekiq_interactive_config_file}.backup"
  FileUtils.mv  sidekiq_autoscheduled_config_file, "#{sidekiq_autoscheduled_config_file}.backup"
  FileUtils.mv  sidekiq_enrichment_config_file, "#{sidekiq_enrichment_config_file}.backup"
  FileUtils.mv  sidekiq_app_config_file, "#{sidekiq_app_config_file}.backup"
  FileUtils.mv  geolocation_database, "#{geolocation_database}.backup"
  FileUtils.mv  web_accounts_list, "#{web_accounts_list}.backup"
end

desc "System Setup"
task :setup do

  puts "[+] Setup initiated!"

  autogenerated_system_pass = "#{(0...16).map { ('a'..'z').to_a[rand(26)] }.join}"
  puts "[+] Generating system password: #{autogenerated_system_pass}"

  ## Copy puma config into place
  puts "[+] Copying puma config...."
  if File.exist? puma_config_file
    puts "[ ] File already exists, skipping: #{puma_config_file}"
  else
    puts "[+] Creating.... #{puma_config_file}"
    FileUtils.cp "#{puma_config_file}.default", puma_config_file
  end

  ## Copy system config into place
  puts "[+] Copying system config...."
  if File.exist? system_config_file
    puts "[ ] File already exists, skipping: #{system_config_file}"
  else
    puts "[+] Creating.... #{system_config_file}"
    FileUtils.cp "#{system_config_file}.default", system_config_file

    # Set up our password
    config = JSON.parse(File.read(system_config_file))
    config["credentials"]["password"] = autogenerated_system_pass
    File.open(system_config_file,"w").puts JSON.pretty_generate(config)
  end

  ## Copy database config into place
  puts "[+] Copying database config...."
  if File.exist? database_config_file
    puts "[ ] File already exists, skipping: #{database_config_file}"

  else
    puts "[+] Creating.... #{database_config_file}"
    FileUtils.cp "#{database_config_file}.default", database_config_file

    # Set up our password
    config = YAML.load_file(database_config_file)
    config["development"]["password"] = autogenerated_system_pass
    config["production"]["password"] = autogenerated_system_pass
    config["docker"]["password"] = autogenerated_system_pass
    File.open(database_config_file,"w").puts YAML.dump config
  end

  ## Copy sidekiq task worker config into place
  puts "[+] Setting up task worker config...."
  if File.exist?(sidekiq_interactive_config_file &&
      sidekiq_autoscheduled_config_file &&
      sidekiq_enrichment_config_file &&
      sidekiq_app_config_file)
    puts "[ ] File already exists, skipping: #{sidekiq_interactive_config_file}"
    puts "[ ] File already exists, skipping: #{sidekiq_autoscheduled_config_file}"
    puts "[ ] File already exists, skipping: #{sidekiq_enrichment_config_file}"
    puts "[ ] File already exists, skipping: #{sidekiq_app_config_file}"
  else
    puts "[+] Copying: #{sidekiq_interactive_config_file}.default"
    puts "[+] Copying: #{sidekiq_autoscheduled_config_file}.default"
    puts "[+] Copying: #{sidekiq_enrichment_config_file}.default"
    puts "[+] Copying: #{sidekiq_app_config_file}.default"
    FileUtils.cp "#{sidekiq_interactive_config_file}.default", sidekiq_interactive_config_file
    FileUtils.cp "#{sidekiq_autoscheduled_config_file}.default", sidekiq_autoscheduled_config_file
    FileUtils.cp "#{sidekiq_enrichment_config_file}.default", sidekiq_enrichment_config_file
    FileUtils.cp "#{sidekiq_app_config_file}.default", sidekiq_app_config_file
  end

  puts "[+] Obtaining latest data..."
  unless File.exist? geolocation_database && web_accounts_list
    puts "Getting data files (will fail if we don't have internet)"
    Dir.chdir("#{intrigue_basedir}/data/"){ puts %x["./get_latest.sh"] }
  end

  ## Copy control script
  puts "[+] Copying control script..."
  if File.exist? control_script
    puts "[ ] File already exists, skipping: #{control_script}"
  else
    puts "[+] Creating.... #{control_script}"
    FileUtils.cp "#{control_script}.default", control_script

    # Configure the IDIR directory
    script_text = File.read(control_script)
    new_script_text = script_text.gsub("IDIR=/path/to/install/directory","IDIR=#{intrigue_basedir}")
    File.open(control_script,"w").puts new_script_text

    # Make a link if
    if Dir.exist?("/etc/init.d") && !File.exist?("#{intrigue_basedir}/util/control.sh")
      puts '[+] Creating system-level startup script'
      `ln -s #{intrigue_basedir}/util/control.sh /etc/init.d/intrigue`
    end

  end

end

desc "Reset Workers"
task :reset_workers do
  puts "[ ] Resetting workers"
  require './core'
  Intrigue::Model::Project.all.each do |p|
    puts "[+] Clean state for #{p.name}"
    p.graph_generation_in_progress=false
    p.save
  end
end

#desc "Run Specs"
#task :spec do
#end

#desc "Run Integration Specs (requires API running)"
#task :integration do
#  t.rspec_opts = "--pattern spec/integration/*_spec.rb"
#end

require "sequel"
Sequel.extension :migration
DB = Sequel.connect('postgres://intrigue:intrigue@localhost:5432/intriguedb')

namespace :db do

  desc "Prints current schema version"
  task :version do
    version = if DB.tables.include?(:schema_info)
      DB[:schema_info].first[:version]
    end || 0
    puts "[+] Schema Version: #{version}"
  end

  desc "Perform migration up to latest migration available"
  task :migrate => :setup do
    Sequel::Migrator.run(DB, "db")
    Rake::Task['db:version'].execute
  end

  desc "Perform rollback to specified target or full rollback as default"
  task :rollback, :target do |t, args|
    args.with_defaults(:target => 0)
    Sequel::Migrator.run(DB, "db", :target => args[:target].to_i)
    Rake::Task['db:version'].execute
  end

  desc "Perform migration reset (full rollback and migration)"
  task :reset do
    Sequel::Migrator.run(DB, "db", :target => 0)
    Sequel::Migrator.run(DB, "db")
    Rake::Task['db:version'].execute
  end
end
